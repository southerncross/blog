<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一个URL编码引发的小插曲 | Lishunyang&#39;s Blog</title>
    <meta name="description" content="Lishunyang&#39;s Blog">
    <link rel="icon" type="image/png" href="/favicon.png">
  <meta name="keywords" content="Javascript,HTTP,Nodejs,React">
    
    <link rel="preload" href="/assets/css/0.styles.1049df1f.css" as="style"><link rel="preload" href="/assets/js/app.cd5892af.js" as="script"><link rel="preload" href="/assets/js/3.6f4cefaa.js" as="script"><link rel="preload" href="/assets/js/17.dd9c4d18.js" as="script">
    <link rel="stylesheet" href="/assets/css/0.styles.1049df1f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div data-v-ad494eec><ul class="container" data-v-26d88251 data-v-ad494eec><li class="title" data-v-26d88251><a href="/" data-v-26d88251><img src="/assets/img/avatar.cf743a85.jpg" class="avatar" data-v-26d88251>Lishunyang's Blog</a></li> <li class="item" data-v-26d88251><a href="/about.html" data-v-26d88251>About</a></li></ul> <div class="main" data-v-ad494eec><div class="container" data-v-63da4bd6 data-v-ad494eec><div class="header" data-v-63da4bd6><h1 class="title" data-v-63da4bd6>一个URL编码引发的小插曲</h1> <div class="date-and-tags" data-v-63da4bd6><span class="date" data-v-63da4bd6>2020/5/18</span> <!----></div></div> <!----> <div class="content" data-v-63da4bd6><div class="content__default" data-v-63da4bd6><p>最近遇到一个跟URL编码有关的bug，简单来说是有这样一段代码：</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">'https://test.example.com?ids[]=1&amp;ids[]=2'</span><span class="token punctuation">;</span>
</code></pre></div><p>本意是想将浏览器跳转到<code>https://test.example.com?ids[]=1&amp;ids[]=2</code>这个地址，结果nginx报非法的URL错误。</p> <p>怎么回事呢？问题出在了URL的<code>[]</code>上。</p> <p>根据RFC3986对URI语法的<a href="https://tools.ietf.org/html/rfc3986#section-3" target="_blank" rel="noopener noreferrer">定义<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，URI的表现形式是这样的：</p> <div class="language- extra-class"><pre class="language-text"><code>foo://example.com:8042/over/there?name=ferret#nose
\_/   \______________/\_________/ \_________/ \__/
 |           |            |            |        |
scheme   authority       path        query   fragment
</code></pre></div><p>上面的<code>scheme</code>，<code>authority</code>，<code>path</code>，<code>query</code>，<code>fragment</code>叫做<strong>component</strong>（也就是encodeURIComponent里面那个component）。规范还说component之间必须适用规定的符号相连。比如scheme和authority之间必须是通过<code>://</code>连接，path和query之间必须是通过<code>?</code>连接。这些用于分隔component的符号，被称作component delimiter（组件分隔符），规范里给出的名字是generic delimiter（通用分隔符），简写为<code>gen-delims</code>。此外还有一个叫<code>sub-delims</code>的概念，这个说的是在component内部的分隔符，不过这个不是重点。</p> <p>为了避免分隔符与URI中的其他数据部分混淆，这些分隔符被定义为了保留字符（reserved）。“保留”是什么意思呢？规范是这样规定的：</p> <blockquote><p>If data for a URI component would conflict with a reserved
character's purpose as a delimiter, then the conflicting data must be
percent-encoded before the URI is formed.</p></blockquote> <p>大意就是：如果可能会导致歧义，则应该将保留字符用百分号编码转码。</p> <p>保留字符有哪些呢？根据最新的URI语法规范<a href="https://tools.ietf.org/html/rfc3986#section-2.2" target="_blank" rel="noopener noreferrer">RFC-3986<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <ul><li>gen-delims：<code>:</code>，<code>/</code>，<code>?</code>，<code>#</code>，<code>[</code>，<code>]</code>，<code>@</code></li> <li>sub-delims：<code>!</code>，<code>$</code>，<code>&amp;</code>，<code>'</code>，<code>(</code>，<code>)</code>，<code>*</code>，<code>+</code>，<code>,</code>，<code>;</code>，<code>=</code></li></ul> <p>我们看到了<code>[]</code>是属于保留字符的，而且还是保留字符中比较“高级”的gen-delims</p> <p>javascript内置一个<code>encodeURI</code>这个函数，作用是将非URL字符集内的字符进行百分号编码，但它不会对保留字符编码。</p> <p><img src="/assets/img/encode_uri_description.26935c30.png" alt=""></p> <p>我们来做个小试验：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">encodeURI</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">?:/[]#@!$&amp;'()*+,;=</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token comment">// 输出 ?:/%5B%5D#@!$&amp;'()*+,;=</span>
</code></pre></div><p>奇怪，为什么<code>[</code>和<code>]</code>被百分号编码了呢？难道<code>[]</code>不是合法的URL字符集吗？显然<code>[]</code>是合法的URL字符，比如我们经常见到带有方括号的url，例如你可以在浏览器的地址栏里输入<code>https://stackoverflow.com/search?q=square+brackets+[中文]</code>，对应页面可以正常加载，并且从开发者工具上可以看到，浏览器发出GET请求时对里面的“中文”编码了，而<code>[]</code>确实是没有编码的：</p> <p><img src="data:image/png;base64,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fPKJ55t/+ukn/PnPf8avfvUrhEIhvHnzBu/evTOfHxkZwfDwMN68eYPh4WFLYlJRqVTw97//Hb/+9a9x4cKFbmxTX5MGyVEnXpKM7p0mpKTTz2lJWyLqnMw958oBZ8uPP/4IALh48eIxl4SoO1inqd+wTp8+HY/kGBwcxMDAgDkVxUknIziIiIiIiIiIiPzoKCfHwMCAmWuDiM4OySfTSn4VInJWrVYRCoUcpwERERERUWs6GsnRaDTw7t07fP/99/jvf/+Ln3/+GQcHBzg4OPB838DAAAYHBzE8PIzXr193UgQiOmKJRIJZzom6SF3Wm4iIiIg60/F0lf39ffzrX//C3/72N/znP//Bzz//3DTLqowA+fDDDzE2NoaPP/6402KcGceVB4GNcCIiIiIiIjrpOgpyXLhwAb/97W+7VRYiIiIiIiIiorZ1lJODiIiIiIiIiOikYJCDiIiIiIiIiPoCgxxERERERERE1BcY5CAiIiIiIiKivuCZePTDDz88qnIQERERnVlsc1G/YZ2mfsM6fXpwJAcRERERERER9QUGOYiIiIiIiIioLzDIQURERERERER9wTMnRzNv375FvV7H3t5eW+8fGhpCo9HA0NAQLl68iOHh4U6KQ0RERERERERnWEdBjr29PXz//fc4ODjABx980NJ7BwYGcO7cObx58wYAcOHCBQY5iIiIiIiIiKht/w9RdqZYasqgrQAAAABJRU5ErkJggg==" alt=""></p> <p>说明<code>[]</code>不需要编码也能用，至少是合法的URL字符集。其实这段推理有点废话，因为既然都是保留字符了，怎么可能不在URL的字符集里面😑</p> <p>但是<code>encodeURI</code>测试，方括号确实是会被转义的:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">encodeURI</span><span class="token punctuation">(</span><span class="token string">'https://stackoverflow.com/search?q=square+brackets+[中文]'</span><span class="token punctuation">)</span>
<span class="token comment">// 输出 https://stackoverflow.com/search?q=square+brackets+%5B%E4%B8%AD%E6%96%87%5D</span>
</code></pre></div><p>其实还有一个问题一直困扰着我，既然<code>[]</code>是保留字符，还是gen-delims，但是怎么印象中没见过URL中有拿<code>[]</code>做特殊分隔符的例子？</p> <p>查询规范才知道，原来<code>[]</code>只在表示ipv6地址时才作为gen-delims，即：</p> <blockquote><p>IP-literal    = &quot;[&quot; ( IPv6address / IPvFuture  ) &quot;]&quot;</p></blockquote> <p>比如下面这些典型的ipv6的URL：</p> <div class="language- extra-class"><pre class="language-text"><code>http://[1080:0:0:0:8:800:200C:417A]/index.html
http://[1080::8:800:200C:417A]/foo
http://[2010:836B:4179::836B:4179]
</code></pre></div><p>怪不得平时见不到，原来只在ipv6的地址时才出现啊。</p> <p>因为v6地址使用<code>:</code>分隔地址段，而<code>:</code>已经是gen-delims了，总不能为了写个v6地址把<code>:</code>都换成<code>%3A</code>吧？这样也太傻了，不仅可读性下降而且编辑操作起来也麻烦，所以，干脆在外面包裹一个<code>[]</code>吧！为了以示区分，也把<code>[]</code>设计为保留字符吧！🤦</p> <p>后来在仔细阅读MDN有关encodeURI的文档时，偶然间发现这里提到的URI的规范是RFC-2396，而我之前参考的规范是RFC-3986，从名字上就可以看出，RFC-3986是更新的规范。仔细观察发现RFC-2396发布时间是1998年，RFC-3986的发布时间是2005年，都已经是“古董”级别了。。</p> <p>于是就翻了翻RFC-2396，果然发现在这一版规范里，<code>[]</code>是没有被设计成保留字符，而是被分类在了“危险字符”（unwise），规范里给出的理由是：这类字符可能被网关或其他网络代理无意间修改掉，所以这类字符没有算在合法的URL字符集里，其他的unwise字符还有<code>{}</code>，<code>|</code>，<code>\</code>，<code>^</code>等。也许是因为这个原因，encodeURI才会将<code>[]</code>编码了，因为在他看来<code>[]</code>不是合法的URL字符集。</p> <p>为了验证这个猜想，又有了如下试验：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">encodeURI</span><span class="token punctuation">(</span><span class="token string">'{}[]|^'</span><span class="token punctuation">)</span>
<span class="token comment">// 输出 %7B%7D%5B%5D%7C%5E</span>
</code></pre></div><p>果然，这些全都被转码了。</p> <p>其实在RFC-3986的附录部分有一段关于规范升级的备注：</p> <p><img src="/assets/img/rfc_2396_changelog.33a96adb.png" alt=""></p> <p>大意就是，原先的规范写得不严谨，问题和争议很多，现在这部分重新优化了一下云云。</p> <p>所以，浏览器的行为是对的，因为按照最新的规范，<code>[]</code>已经是保留字符，是合法的URL字符集了，所以不需要转义。而encodeURI还是沿用了老的规范，认为<code>[]</code>不是合法的URL字符集，所以就给转义了。</p> <p>到这里，文章最开始的问题答案算是出来了，浏览器沿用最新的规范认为<code>[]</code>是合法的URL字符所以没有对<code>[]</code>转码，而后端的nginx沿用了旧规范认为<code>[]</code>不是合法的字符，所以报了非法URL错误。最后问题的解决办法也是通过修改nginx配置解决的。所以，最开头的代码，不完全算错，只能说是兼容性不是很好。</p> <p>对了，你可能会在想，上面的代码似乎有问题吧？比如这样写：</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">'http://test.exmaple.com/中文'</span>
</code></pre></div><p>按理说非URL字符需要百分号编码，这样写出来的URL难道不是错的吗。其实多虑了，这样写跟你在浏览器的地址栏里直接输入中文URL是一样的效果，浏览器在发出请求前会自动帮你做一次“encode”。但是注意，这里的encode可不是直接调用了javascript自带的encodeURI（如果你没看懂这句话，我算是白解释了）。</p> <p>那么，如果要保证兼容性，还是得把URL来个encodeURI靠谱（至少解决了<code>[]</code>的兼容性问题。但这里要注意了，encodeURI的内容如果包含了百分号，那么百分号会被再次encode，得到的结果可能并不是想要的。总之就是，encodeURL这个事情，有点麻烦。。</p> <p>其实本来已经心满意足了，结果我又想了想，既然<code>[]</code>在新版规范里已经属于合法URL字符集了，那之前的一帮难兄难弟诸如<code>{}</code>，<code>|</code>，<code>^</code>是不是也可以平反了？但是翻遍了RFC-3986也没有看到关于这几个字符的调整，所以说这几个仍然算是unwise字符咯？</p> <p>为了满足我的好奇心，我在浏览器中输入一个<code>https://stackoverflow.com/search?q=square+brackets+{中文}</code>（注意最后是个<code>{}</code>）。结果出乎意料，<code>{}</code>也没有被编码：</p> <p><img src="/assets/img/uri_bracket_test.6054784f.png" alt=""></p> <p>然后，经过大概3分钟的加载时间后，stackoverflow挂了🤦</p> <p><img src="/assets/img/stack_overflow_down.e8830573.png" alt=""></p> <p>看来的确是个令人头疼的问题啊</p></div></div> <div class="comment" data-v-63da4bd6><!----></div></div></div> <div class="container" data-v-07c4fbe2 data-v-ad494eec>
  Designed by <a href="/about" data-v-07c4fbe2>Lishunyang</a> | <a href="https://beian.miit.gov.cn/" target="_blank" data-v-07c4fbe2>京ICP备20009157号</a> | All right reserved
</div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.cd5892af.js" defer></script><script src="/assets/js/3.6f4cefaa.js" defer></script><script src="/assets/js/17.dd9c4d18.js" defer></script>
  </body>
</html>
