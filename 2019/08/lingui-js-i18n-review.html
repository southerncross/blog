<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>i18n与lingui-js总结 | Lishunyang&#39;s Blog</title>
    <meta name="description" content="Lishunyang&#39;s Blog">
    <link rel="icon" type="image/png" href="/blog/favicon.png">
  <meta name="keywords" content="Javascript,HTTP,Nodejs,React">
    
    <link rel="preload" href="/blog/assets/css/0.styles.9d0cb107.css" as="style"><link rel="preload" href="/blog/assets/js/app.c8d67ad9.js" as="script"><link rel="preload" href="/blog/assets/js/3.acd1c8f7.js" as="script"><link rel="preload" href="/blog/assets/js/35.3db9a3a8.js" as="script">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.9d0cb107.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div data-v-ad494eec><ul class="container" data-v-37370f15 data-v-ad494eec><li class="title" data-v-37370f15><a href="/blog/" data-v-37370f15><img src="/blog/assets/img/avatar.cf743a85.jpg" class="avatar" data-v-37370f15>Lishunyang's Blog</a></li> <li class="item" data-v-37370f15><a href="/blog/about.html" data-v-37370f15>About</a></li></ul> <div class="main" data-v-ad494eec><div class="container" data-v-63da4bd6 data-v-ad494eec><div class="header" data-v-63da4bd6><h1 class="title" data-v-63da4bd6>i18n与lingui-js总结</h1> <div class="date-and-tags" data-v-63da4bd6><span class="date" data-v-63da4bd6>2019/8/30</span> <span class="tags" data-v-63da4bd6><span class="tag" data-v-63da4bd6>React,</span><span class="tag" data-v-63da4bd6>i18n</span></span></div></div> <!----> <div class="content" data-v-63da4bd6><div class="content__default" data-v-63da4bd6><h1 id="国际化的基本原理"><a href="#国际化的基本原理" class="header-anchor">#</a> 国际化的基本原理</h1> <p>假设下面一段代码，要怎么国际化呢？</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'你好'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>一种常见思路是使用一个translate方法进行翻译，比如：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// translate方法用来把中文翻译为英文</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">translate</span><span class="token punctuation">(</span><span class="token string">'你好'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>translate方法的实现逻辑也很简单，大致就是拿一个汉英大字典，将中文转换成英文，例如：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// dictionary.js</span>
<span class="token keyword">const</span> dictionary <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string-property property">'你好'</span><span class="token operator">:</span> <span class="token string">'You ok'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// index.js</span>
<span class="token keyword">function</span> <span class="token function">translate</span><span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> dictionary</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> dictionary<span class="token punctuation">[</span>message<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这就是国际化的基本原理．</p> <h1 id="国际化方案-1-0"><a href="#国际化方案-1-0" class="header-anchor">#</a> 国际化方案 1.0</h1> <p>通过上面的分析我们知道，国际化的重要内容是构造一个汉英大字典，那么如何构造呢？代码里各种字符串，我怎么知道哪些需要翻译呢？
常见的做法是使用特殊的写法将需要翻译的字符串标记出来，然后借助babel等工具对代码做一次预处理，将需要翻译的文本＂提取＂出来：</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'你好'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 借助babel plugin，我们先将mark对应的文本提取出来，然后将mark偷偷去掉，嘿嘿嘿</span>
</code></pre></div><p>这个过程，就叫做<strong>extract</strong></p> <p>当我们提取了对应的文本后，就会得到一个空的汉英字典：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> dictionary <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string-property property">'你好'</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
  <span class="token string-property property">'我好'</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
  <span class="token string-property property">'大家好'</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>下一步就是找翻译人员将字典补充完整：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> dictionary <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string-property property">'你好'</span><span class="token operator">:</span> <span class="token string">'You ok'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'我好'</span><span class="token operator">:</span> <span class="token string">'I ok'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'大家好'</span><span class="token operator">:</span> <span class="token string">'We ok'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>最终的代码大致是这样：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> dictionary <span class="token keyword">from</span> <span class="token string">'./dictionary.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> mark<span class="token punctuation">,</span> translate <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./i18n.js'</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">translate</span><span class="token punctuation">(</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'你好'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dictionary<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>聪明如你肯定会想到，既然如此，不如把translate和mark合二为一吧，比如这样：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> dictionary <span class="token keyword">from</span> <span class="token string">'./dictionary.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> t <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./i18n.js'</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">t</span><span class="token punctuation">(</span><span class="token string">'你好'</span><span class="token punctuation">,</span> dictionary<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// mark和translate合成了一个t</span>
</code></pre></div><p>甚至dictionary也可以做成配置项，隐式调用，比如：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> dictionary <span class="token keyword">from</span> <span class="token string">'./dictionary.js'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> setDictionary<span class="token punctuation">,</span> t <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./i18n.js'</span><span class="token punctuation">;</span>

<span class="token function">setDictionary</span><span class="token punctuation">(</span>dictionary<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">t</span><span class="token punctuation">(</span><span class="token string">'你好'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// dictionary隐式生效</span>
</code></pre></div><p>看上去不错哦，极大提升了开发效率．不过需要注意的是，单独的mark和translate仍然是有意义的,因为有些翻译场景需要处理的文本是个变量，只能在运行时确定:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'男'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 为了能正常提取待翻译文本,这里先将gender所有可能的值都标记下来</span>
<span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'女'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">translate</span><span class="token punctuation">(</span>gender<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// gender是变量,变量只有在runtime才能够确定</span>
</code></pre></div><h1 id="国际化方案-2-0"><a href="#国际化方案-2-0" class="header-anchor">#</a> 国际化方案 2.0</h1> <p>上面的方法有个问题，只支持对常量文本的翻译:</p> <div class="language-js extra-class"><pre class="language-js"><code>str <span class="token operator">=</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">'小明喜欢篮球吗？'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这能支持常量文本</span>
str <span class="token operator">=</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">喜欢</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sport<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">吗?</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这种是不支持的，想想为什么</span>
</code></pre></div><p>如果遇到带变量的文本，我们只能在变量处切割文本，然后对每一小片单独翻译</p> <div class="language-js extra-class"><pre class="language-js"><code>str <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">'喜欢'</span><span class="token punctuation">)</span> <span class="token operator">+</span> sport <span class="token operator">+</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">'吗?'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>不过这样做的效果有可能很差，首先是构造的字典非常琐碎对翻译人员很不友好：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> dictionary <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string-property property">'喜欢'</span><span class="token operator">:</span> <span class="token string">'like'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'吗?'</span><span class="token operator">:</span> <span class="token string">'?'</span><span class="token punctuation">,</span> <span class="token comment">// 翻译人员：臣妾也无能为力啊</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其次是拼接出来的语序未必符合英文语法，比如上面的例子就会得到：</p> <div class="language- extra-class"><pre class="language-text"><code>XiaoMing like basketball?
</code></pre></div><p>这显然不是一个好的结果，正常的翻译结果应该是：</p> <div class="language- extra-class"><pre class="language-text"><code>Does XiaoMing like basketball?
</code></pre></div><p>要解决这个问题，我们的汉英字典就需要升级，要支持嵌套变量，比如：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> dictionary <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string-property property">'{name}喜欢{sport}吗?'</span><span class="token operator">:</span> <span class="token string">''</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>此外我们的字典要支持变量插入：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> dictionary <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string-property property">'{name}喜欢{sport}吗?'</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">values</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 字典的value已经不是一个单纯的文本，而是一个可以传入参数的callback方法．</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Does </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>values<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> like </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>values<span class="token punctuation">.</span>sport<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 此时的t还负责执行字典的方法</span>
<span class="token keyword">function</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> values</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> dictionary<span class="token punctuation">[</span>message<span class="token punctuation">]</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// t的用法</span>
<span class="token function">t</span><span class="token punctuation">(</span><span class="token string">'{name}喜欢{sport}吗?'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'XiaoMing'</span><span class="token punctuation">,</span> <span class="token literal-property property">sport</span><span class="token operator">:</span> <span class="token string">'basketball'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>构造新的字典不光是翻译，还要生成对应的callback．这个过程叫<strong>compile</strong>．</p> <p>实际情况中可不只是简单的替换变量就行了，有时候还涉及到时态，单复数，序数等变种．那如何统一规则呢？答案是使用统一的ICU format书写message．
ICU format就是专门用来解决这个问题存在的，它是一个通用的格式，有一定的语法，就好比markdown一样．使用这种格式构造字典并实现翻译逻辑，就能完美解决我们的问题了！</p> <p>当然，这个方案有个fallback的小缺陷．</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">t</span><span class="token punctuation">(</span><span class="token string">'你好'</span><span class="token punctuation">)</span> <span class="token comment">// 对中文的翻译，如果字典的翻译缺失，大不了把中文直接展示出来即可（fallback到message）</span>
<span class="token function">t</span><span class="token punctuation">(</span><span class="token string">'{name}喜欢{sport}吗?'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'XiaoMing'</span><span class="token punctuation">,</span> <span class="token literal-property property">sport</span><span class="token operator">:</span> <span class="token string">'basketball'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 由于'{name}喜欢{sport}吗?'不是一个合法的string，所以如果字典缺失，fallback到message，只能显示一段'{name}喜欢{sport}吗?'类似的文本．</span>
</code></pre></div><p>也就是说，只要有遇到带文本变量嵌套的翻译文本，就必须构造一次字典，以保证待翻译的文本在字典里能够找得到．</p> <h1 id="国际化方案-3-0"><a href="#国际化方案-3-0" class="header-anchor">#</a> 国际化方案 3.0</h1> <p>让我们在仔细看看我们目前的方案：</p> <div class="language-js extra-class"><pre class="language-js"><code>str <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">喜欢</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sport<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">吗?</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span> <span class="token comment">// 国际化以前</span>

str <span class="token operator">=</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">'{name}喜欢{sport}吗?'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> sport <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// 国际化以后</span>
</code></pre></div><p>上面的方案虽然解决了问题，但对开发人员很不友好啊，国际化之前和国际化之后的写法也差太多了，而且很不直观．怎么办呢？</p> <p>答案是借助babel的力量，在编译阶段替我们做一些事情，比如：</p> <div class="language-js extra-class"><pre class="language-js"><code>str <span class="token operator">=</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">喜欢</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>sport<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">吗?</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token comment">// 原始写法</span>

str <span class="token operator">=</span> <span class="token function">t</span><span class="token punctuation">(</span><span class="token string">'{name}喜欢{sport}吗?'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> sport <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// babel-plugin处理后的代码</span>
</code></pre></div><p>太棒了，这下我们既能保证开发的友好程度，又能做到国际化了！
但仔细想想，这个bebel-plugin该怎么写呢？且听下回分解．</p> <h1 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h1> <ol><li>国际化就是查字典</li> <li>mark收集（预处理阶段），translate翻译（运行时阶段）</li> <li>ICU format &amp; 优化的babel-plugin写法</li></ol></div></div> <div class="comment" data-v-63da4bd6><!----></div></div></div> <div class="container" data-v-07c4fbe2 data-v-ad494eec>
  Designed by <a href="/about" data-v-07c4fbe2>Lishunyang</a> | <a href="https://beian.miit.gov.cn/" target="_blank" data-v-07c4fbe2>京ICP备20009157号</a> | All right reserved
</div></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.c8d67ad9.js" defer></script><script src="/blog/assets/js/3.acd1c8f7.js" defer></script><script src="/blog/assets/js/35.3db9a3a8.js" defer></script>
  </body>
</html>
