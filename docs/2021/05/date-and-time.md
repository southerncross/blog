---
title: 日期和时间
date: 2021-05-16 13:40
tags: time
---

## 日期和时间的问题

我们是做HR SaaS系统的，日期和时间的问题没给我们少添麻烦。

最开始我们服务的都是国内的客户，一直没什么问题，但是突然有一天接到了一个客户投诉，他说他给候选人安排了一场上午10点的面试，但是候选人直到第二天下午才收到通知。经过调查发现，这个客户和候选人他们都身在美国，而我们系统中存储的时间默认都是北京时间，所以他创建的面试时间实际上是北京时间的上午10点，自然后续的通知就错乱了。至于为什么之前大家都没有发现这个问题，因为国内都是统一的北京时间，感谢祖国感谢党。

经过这个事件后，我们决定将系统中所有的日期和时间都更换成带有时区的格式，这样HR在创建面试的时候，我们就知道这是美国时区的上午10点，后端服务在做时间比对的时候也能正常识别。

但很快我们又接到了一个用户投诉，他说自己明明是在12月31号入职的，但是系统中显示的却是第二年的1月1号，因为入职时间差了一年导致自己享受不到很多公司的福利政策。经过调查我们发现，此人的入职办理地点是在美国，而随后他就前往了中国办公，系统中存储的入职时间是美国当地时区的12月31日，在中国境内展示的时候转换到北京时间就变成了第二年的1月1日。啊这。。

经过这个事件后，我们决定将系统中有关日期和时间的逻辑调整为：精确到天的日期不保留时区，精确到天以内的时间保留时区。这样再面对上面的例子时，入职日期因为没有时区，所以在全世界任何地方展示都是相同的了。

这样就可以了吗？如果精确到分钟的时间都带着时区，假设你设定了一个明天早上8点30分的闹钟叫自己起床，接着你坐上了从中国飞往美国的航班。。。想象一下会发生什么场景，无论怎样，几乎可以确定的是这个闹钟不是叫你起床的。

闹钟就不应该带时区吗？假如你想观看奥运会开幕式直播，新闻上说现场转播将会在第二天晚上10点开始，如果你定了一个不带时区的晚上10点的闹钟，接着你坐上了从中国飞往美国的航班。。。想象一下会发生什么场景，同样的，你大概率会错过直播。

怎么样，乱了吗。。。

## 要时区还是不要时区？

时区的产生，本质上是因为全世界没有采用一套统一的计时规则，各地都有自己的当地时间。这是合理的，否则反而可能会对生活生产带来各种不便，比如每年的圣诞节应该是天寒地冻的日子，圣诞老人穿着厚厚的棉袄，结果在南半球的澳大利亚，大家都穿着短衣短袖，圣诞老人简直要热死。

因为有各种各样本地时间的存在，为了让不同地区的人知道彼此的相对时间，才出现了时区的概念，可以说时区是对本地时间的补充。

```
时区 + 本地时间 = 通用时间
```

其实等价于下面这样一句废话：

```
时区 + 不带时区时间 = 带时区的时间
```

所以，究竟一个日期或者时间要不要时区呢？就看这个时间是要表达“本地时间”还是想要表达“通用时间”。有一个非常简单的手段来检验这一点：

~~如果那两个字没有颤抖~~

**如果时区发生变化，你想要表达的时间是否也应该发生变化？** 如果是，那么你应该用通用时间（带时区），如果不是，那么你应该用本地时间（不带时区）。

回到上面的例子，面试时间，显然应该用通用时间（带时区），入职日期显然应该用本地时间（不带时区），叫你起床的闹钟显然应该用本地时间（不带时区），奥运会直播的闹钟显然应该用通用时间（带时区）。

是的，那些无脑地根据精度判断是否需要时区的做法是错的，正确的做法就是得具体问题具体分析。

## 如何区分时区

如何表示一个带时区或者不带时区的日期/时间呢？

先介绍几个常见概念

- timestamp：时间戳，这个应该都能理解，是相对于1970年1月1日0点0分0秒的毫秒偏移量。

- GMT：格林尼治标准时间，也就是0时区的时间，它是基于地球自转的天文观测得出的。
- UTC：协调世界时间，也是0时区的时间，他是基于原子钟校准得到的。

> 通常可以认为GMT和UTC可以相互替换，因为二者都表示的是0时区的时间（javascript里Date.prototype.toUTCString和Date.prototype.toGMTString其实是一个函数）。严格上讲，因为UTC更精确，所以科学界都用UTC。UTC的全称是Coordinated Universal Time，至于为啥缩写成了UTC而不是CUT，也有一个故事。。

- DST：夏时制，这个跟时区无关，指的是某些地方会在夏天把钟播快一小时（夏令时），到了冬天再拨回去（冬令时），主要是为了节省照明资源。

> 我国曾经在1986年到1991年期间短暂实行过夏令时和冬令时。因为后续发现省电效果不够明显，反而给人们生活带来很多不便，随后就废弃了。美国至今仍然是夏时制，所以这些地方的程序员在换算时间的时候还需要额外考虑DST的影响。

- ISO8601：一个日期规范，一般长这样`2021-05-16`、`2021-05-16T15:10:37+08:00`或`2021-05-16T15:10:37Z`。ISO8601是目前最主流的表示日期的规范格式，详细的定义见[这里](https://en.wikipedia.org/wiki/ISO_8601)

- RFC2822：也是一个日期规范，一般长这样`Sun, 16 May 2021 08:21:33 GMT`，这也是javascript中Date默认的toString的格式，详细规范见[这里](https://datatracker.ietf.org/doc/html/rfc2822#section-3.3)。RFC2822是非常老的一个格式规范，主要是给人看的，英语国家用着爽，但是非英语国家用起来麻烦，所以不推荐使用这种格式了。

- RFC3339：还是一个日期规范，基于ISO8601，做了一些约定和调整，比如分隔日期和时间的字符从T换成了空格。

根据MDN的文档（见[这里](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Date/parse#parameters)），Date的构造方法支持RFC2822和ISO8601两种格式的日期时间表达式，但是规范同样也强烈不建议用字符串的方式初始化Date对象，因为不同浏览器之间存在差异。

![Do not use date string](./date-parse.png)

现在问题来了，下面一个date对象，表示的究竟是什么时间呢？

```js
const date = new Date('2021-05-16 18:00:00'); // 带时区吗？
```

根据MDN文档，如果提供的日期中不包含时区信息，则将会按照本地时区解析。同样地，moment.js的构造函数也是这个逻辑。

第二个问题，打印下面的date对象，将会得到什么样的时间格式呢？

```js
console.log(new Date('2021-05-16 18:00:00')); // 什么样的格式呢？
```

在我的电脑上（chrome浏览器），得到的结果是这样`Sun May 16 2021 18:00:00 GMT+0800 (中国标准时间)`，如果把浏览器语言调整为英文，得到的结果会变成这样`Date Sun May 16 2021 18:00:00 GMT+0800 (China Standard Time)`，如果换成IE，会报一个错误，认为这不是一个合法的时间字符串。

可以看到，默认情况下Date转成string的输出格式是RFC2822，带有时区，并且时区名字与语言有关。至于为什么选择RFC2822的规范，个人猜测是兼容性原因，毕竟ISO8601和RFC3339都是后面才出来的。其实javascript提供了很多格式的输出方法，比如：`toUTCString`、`toGMTString`、`toISOString`、`toLocaleString`等等，以满足不同的需要。

而在MySQL中，主要的日期和时间的格式有DATE和DATETIME两种。其中，DATE类型的格式是`2021-05-16`（精确到天），DATETIME的格式是`2021-05-16 18:00:00`（精确到秒）。

DATE和DATETIME除了精度的区别外有一个非常关键的区别，那就是**DATE格式与时区无关，DATETIME与时区有关**。那这里就有一个问题了，DATETIME的格式是`2021-05-16 18:00:00`，看上去没有时区信息，那怎么跟时区有关的呢？

MySQL的做法是在数据库实例内部维持了一个时区的配置，所有的DATETIME都会被转换成这个时区下的本地时间。比如在东八区，那么你看到数据库中所有的DATETIME都是东八区下的本地时间。如果这个时区的配置发生变化，MySQL会自动将所有DATETIME类型的时间转换到新的时区。

而从MySQL中查询直接得到的DATETIME输出格式默认并不携带时区信息，但时区信息不会出现在默认的输出格式里，你需要手动将其转换成带时区的格式，比如使用`DATE_FORMAT`这样的日期转换函数，或者手动在外部代码中处理。同样的，在insert或者update的时候，传给MySQL的DATETIME类型也都只能是不带时区的格式例如`YYYY-MM-DD HH:mm:ss`，如果你想直接insert一个ISO8601格式的字符串可以借助`STR_TO_DATE`这样的日期转换函数。

简单总结一下就是，如果是DATE类型的数据，为了保证
